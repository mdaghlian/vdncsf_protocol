clear all;load rawSpectra_030911_scanner;nStandard = 17:17:272;nSamp = setdiff(1:size(rawRGBValues,1),nStandard);rgbValues = rawRGBValues(nSamp,:);spectra = rawSpectra(:,nSamp);normFactor = sum(rawSpectra(:,nStandard),1); normFactor = normFactor/mean(normFactor);nStandard = [0,nStandard];for ii = 1:length(nStandard)-1;	tj = find(nSamp<nStandard(ii+1) & nSamp>nStandard(ii));	spectra(:,tj) = spectra(:,tj)/normFactor(ii);end% bad measurements have NaNs in either the spectra or the rgbValuesgoodMeasurements = intersect(find(~isnan(spectra(1,:)))', find(~isnan(rgbValues(:,1))));disp(['found ',num2str(length(goodMeasurements)),' good measurements out of ',...        num2str(size(rgbValues,1)),'.']);s = spectra(:,goodMeasurements);rgb = rgbValues(goodMeasurements,:);% Pull out red, green and blue measurementsrgbIndices{1} = rgb(:,1)>0 & rgb(:,2)==0 & rgb(:,3)==0;rgbIndices{2} = rgb(:,2)>0 & rgb(:,1)==0 & rgb(:,3)==0;rgbIndices{3} = rgb(:,3)>0 & rgb(:,1)==0 & rgb(:,2)==0;% white is often run also, to check additivitywht = rgb(:,1)==rgb(:,2) & rgb(:,2)==rgb(:,3) & rgb(:,1)>0;% the black level is important tooblk = rgb(:,1)==0 & rgb(:,2)==0 & rgb(:,3)==0;% HACK! Sometimes the data have a bogus dark value (how? measurement error??)blk = find(blk);tmp=mean(s(:,blk))';tmp=tmp-min(tmp);blk = blk(tmp<10);% END HACKrawRad.blk = sum(s(:,blk))';blackLevel = mean(rawRad.blk);rawRad.whtDacVals = rgb(wht,1);rawRad.wht = sum(s(:,wht))';for(ii=1:3)    rawRad.rgb{ii} = sum(s(:,rgbIndices{ii}))';%no normalization	%    rawRad.normRgb{ii} = (rawRad.rgb{ii}-blackLevel)./(max(rawRad.rgb{ii})-blackLevel);    rawRad.normRgb{ii} = (rawRad.rgb{ii}-blackLevel);    % clean things up a bit.    rawRad.normRgb{ii}(rawRad.normRgb{ii}<0) = 0;    rawRad.dacVals{ii} = rgb(rgbIndices{ii},ii);enddarkSpect = mean(s(:,blk)')';%darkSpectStdev = std(s(:,blk)')';s = s-repmat(darkSpect,1,size(s,2));monitorSpectra(1,:) = sum(s(:,rgbIndices{1})');monitorSpectra(2,:) = sum(s(:,rgbIndices{2})');monitorSpectra(3,:) = sum(s(:,rgbIndices{3})');monitorSpectra(4,:) = sum(s(:,wht)');cmapMax = 2^nbits-1;%fit, one by oneii = 1; xx = [0;rawRad.dacVals{ii}]; yy = [0;rawRad.normRgb{ii}];[xx orders] = unique(xx); yy = yy(orders);xx = xx(1:end-1)/cmapMax; yy = yy(1:end-1);N = 9; figure,plot(xx,yy,'x'); hold on;[p1 junk] = polyfit(xx,yy,N); plot((0:1023)/1023,polyval(p1,(0:1023)/1023));%sqrt(mean(((yy(2:end)-polyval(p1,xx(2:end))).^2)./yy(2:end)))ii = 2; xx = [0;rawRad.dacVals{ii}]; yy = [0;rawRad.normRgb{ii}];[xx orders] = unique(xx); yy = yy(orders);xx = xx/cmapMax;N = 8; figure,plot(xx,yy,'x'); hold on;[p2 junk] = polyfit(xx,yy,N); plot((0:1023)/1023,polyval(p2,(0:1023)/1023));%sqrt(mean(((yy(2:end)-polyval(p2,xx(2:end))).^2)./yy(2:end)))ii = 3; xx = [0;rawRad.dacVals{ii}]; yy = [0;rawRad.normRgb{ii}];[xx orders] = unique(xx); yy = yy(orders);xx = xx(1:end-2)/cmapMax; yy = yy(1:end-2);N = 8; figure,plot(xx,yy,'x'); hold on;[p3 junk] = polyfit(xx,yy,N); plot((0:1023)/1023,polyval(p3,(0:1023)/1023));%sqrt(mean(((yy(2:end)-polyval(p3,xx(2:end))).^2)./yy(2:end)))invGamma(:,1) = polyval(p1,(0:cmapMax)'/cmapMax)/polyval(p1,1);invGamma(:,2) = polyval(p2,(0:cmapMax)'/cmapMax)/polyval(p2,1);invGamma(:,3) = polyval(p3,(0:cmapMax)'/cmapMax)/polyval(p3,1);%normalization of negatives, sorry...invGamma(1:79,2) = 0; invGamma(1,3) = 0;%roundinvGammaTable = round(invGamma*1023);gamma = zeros(cmapMax+1,3);precise = (0:0.01:cmapMax)'/cmapMax; p = {p1;p2;p3};returnfor jj = 1:3	tmp = polyval(p{jj},precise)/polyval(p{jj},1);	for ii=0:cmapMax;		[junk placetmp] = min(abs(ii/cmapMax-tmp));		gamma(ii+1,jj) = precise(placetmp);	endendgammaTable = round(gamma*cmapMax);save('gamma','invGamma','invGammaTable','gamma','gammaTable');normFactor(:,1) = invGamma(716,1)./invGamma([695 707 719 730 741],1);monitorSpectra(:,1) = mean(s(:,[229 149 21 53 249]).*repmat(normFactor(:,1)',361,1),2);normFactor(:,2) = invGamma(732,2)./invGamma([695 707 719 730 741],2);monitorSpectra(:,2) = mean(s(:,[229 149 21 53 249]+1).*repmat(normFactor(:,2)',361,1),2);normFactor(:,3) = invGamma(703,3)./invGamma([695 707 719 730 741],3);monitorSpectra(:,3) = mean(s(:,[229 149 21 53 249]+2).*repmat(normFactor(:,3)',361,1),2);%normFactor(:,4) = mean(normFactor(:,1:3),2);%monitorSpectra(:,4) = mean(s(:,[229 149 21 53 249]+3).*repmat(normFactor(:,4)',361,1),2);monitorSpectra(:,4) = sum(monitorSpectra(:,1:3),2);return