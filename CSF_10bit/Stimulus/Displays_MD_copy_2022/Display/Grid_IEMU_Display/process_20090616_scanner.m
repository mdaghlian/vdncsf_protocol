function process_scanner;% calibrationx = fliplr([255 223 191 159 128 96 64 32 0])'./255;yi = [10    12      10  12;...      25    47      12  52;...      65    225     26  262;...      116   516     49  644;...      138   840     101 1080;...      245   1620    180 1410;...      423   1920    202 2620;...      519   4160    365 4480;...      845   NaN     539 7130];        %old settings [289 307 315 303;...%     503 1650 330 1860;...%     1190 6500 457 7070;...%     2680 15700 925 18100;...%     4840 29100 1710 35500;...%     6850 42400 2910 NaN;...%     9940 NaN 4320 NaN;...%     13400 NaN 6530 NaN;...%     19700 NaN 8930 NaN];% interp NaN assume similar curvesYint = yi;Yint(:,[2 4])=0;for n=[1 3]    X = [yi(:,n) zeros(size(yi(:,1)))];    Y = yi(:,2);    B = pinv(X(1:7,:))*Y(1:7);    Yint(:,2) = Yint(:,2)+(X*B)./2;        X = [yi(:,n) zeros(size(yi(:,1)))];    Y = yi(:,4);    B = pinv(X(1:5,:))*Y(1:5);    Yint(:,4) = Yint(:,4)+(X*B)./2;end% replace only iffy valuesy = yi;y(8:9,2) = Yint(8:9,2);y = y-mean(yi(1,:));y = y ./ (ones(size(y,1),1)*max(y));% precision = bitsbits = 8;ngamma = 2.^bits;% fitxint = linspace(0,1,ngamma)';for n=1:3,    p{n} = fminsearch(@(a) cumgaussfit(a,x,y(:,n)),[0.5 0.2]');    yint(:,n) = cumulativegaussian(xint,p{n}(1),p{n}(2));    yint(:,n)=yint(:,n)-min(yint(:,n));    yint(:,n)=yint(:,n)./max(yint(:,n));end% invertcmapMax = ngamma-1;gamma = zeros(cmapMax+1,3);precise = (0:0.01:cmapMax)'/cmapMax; for jj = 1:3	tmp = cumulativegaussian(precise,p{jj}(1),p{jj}(2));    tmp = tmp-min(tmp); tmp = tmp./max(tmp);	for ii=0:cmapMax;		[junk placetmp] = min(abs(ii/cmapMax-tmp));		gamma(ii+1,jj) = precise(placetmp);	endendgamma(gamma>1)=1;gamma(gamma<0)=0;% plot gammafigure(1);clf;X = [0:255]'./255;plot(x,y,'o');hold on;plot(x,mean(y,2),'kx','MarkerSize',20);hold on;plot(xint,yint);axis([0 1 0 1]);axis square;% plot inverted gammafigure(2);clf;plot(y,x,'o');hold on;plot(mean(y,2),x,'kx','MarkerSize',20);hold on;plot(xint,gamma);axis([0 1 0 1]);axis square;yint(yint>1)=1;yint(yint<0)=0;gammaTable = round(gamma.*cmapMax);gamma = gammaTable./(ngamma-1);save('gamma.mat','gamma','gammaTable');returnfunction [e]=cumgaussfit(p,x,y)f=cumulativegaussian(x,p(1),p(2));f=f-min(f);f=f./max(f);e=norm(y-f);returnfunction y = cumulativegaussian(x,mu,sigma)y = 0.5 * erfc( (mu - x) ./ (sigma * sqrt(2)));y(y<0) = 0;y(y>1) = 1;return