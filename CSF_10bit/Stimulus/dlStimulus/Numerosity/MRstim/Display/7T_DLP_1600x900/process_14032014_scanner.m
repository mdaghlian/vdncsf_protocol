function process_14032014_scanner;% calibration taken on PR650 luminometer, 01/Dec/2010, for new long cablex = fliplr([255 223 191 159 128 96 64 32 0])'./255;% yi = [NaN   NaN      NaN     NaN;...%       4.65    8.04      4.17     NaN;...%       12.1    36.9      8.09     49.9;...%       25.4    97.2      17.0     131;...%       45.0    186       29.5     252;...%       63.6    273       41.6     372;...  %       85.8    381       56.5     560;...%       114     536       75.6     712;...%       147     793       99.8     1022];% % yi = [6.6   6.6      6.6     6.6;...%       8.4    10.7      8.26     14.1;...%       22.3    45.9      16     70.8;...%       59    146      36     225;...%       129    368       75     551;...%       218    656       121     956;...  %       280    1007       178     1453;...%       363     1613       250     2078;...%       437     2316       296     3018];      yi = [1.48    1.48    1.48    1.48;...      5.74  37.2    4.11    53.3;...      19.3  164     12.6    137;...      42.8  381     26.5    554;...      73.1  649     45.7    985;...      112   1010    69.7    1522;...        167   1535    103     3229;...      211   2025   121     4239;...      214   2311        123 4239];  % d = sum(yi(:,[1:3]),2)-yi(:,4); % diff RGB - white% d = median(d(3:end));% yi(1,:) = d./3; % RGB is higher due to 3x black leakage% yi(2,4) = sum(yi(2,1:3))-d;y = yi;%       % % interp NaN assume similar curves% Yint = yi;% %Yint(:,[2 4])=0;% for n=2%     X = [yi(:,n) zeros(size(yi(:,1)))];%     Y = yi(:,2);%     B = pinv(X(2:9,:))*Y(2:9);%     Yint(:,1) = Yint(:,1)+(X*B)./2;% end% % % % replace only iffy values% y = yi;% %y(8:9,2) = Yint(8:9,2);y = y-mean(yi(1,:));y = y ./ (ones(size(y,1),1)*max(y));% precision = bitsbits = 8;ngamma = 2.^bits;% fitxint = linspace(0,1,ngamma)';for n=1:3,    p{n} = fminsearch(@(a) cumgaussfit(a,x,y(:,n)),[0.5 0.2]');    yint(:,n) = cumulativegaussian(xint,p{n}(1),p{n}(2));    yint(:,n)=yint(:,n)-min(yint(:,n));    yint(:,n)=yint(:,n)./max(yint(:,n));end% invertcmapMax = ngamma-1;gamma = zeros(cmapMax+1,3);precise = (0:0.01:cmapMax)'/cmapMax; for jj = 1:3	tmp = cumulativegaussian(precise,p{jj}(1),p{jj}(2));    tmp = tmp-min(tmp); tmp = tmp./max(tmp);	for ii=0:cmapMax;		[junk placetmp] = min(abs(ii/cmapMax-tmp));		gamma(ii+1,jj) = precise(placetmp);	endendgamma(gamma>1)=1;gamma(gamma<0)=0;% plot gammafigure(1);clf;X = [0:255]'./255;plot(x,y,'o');hold on;plot(x,mean(y,2),'kx','MarkerSize',20);hold on;plot(xint,yint);axis([0 1 0 1]);axis square;% plot inverted gammafigure(2);clf;plot(y,x,'o');hold on;plot(mean(y,2),x,'kx','MarkerSize',20);hold on;plot(xint,gamma);axis([0 1 0 1]);axis square;yint(yint>1)=1;yint(yint<0)=0;gammaTable = round(gamma.*cmapMax);gamma = gammaTable./(ngamma-1);save('gamma.mat','gamma','gammaTable');returnfunction [e]=cumgaussfit(p,x,y)f=cumulativegaussian(x,p(1),p(2));f=f-min(f);f=f./max(f);e=norm(y-f);returnfunction y = cumulativegaussian(x,mu,sigma)y = 0.5 * erfc( (mu - x) ./ (sigma * sqrt(2)));y(y<0) = 0;y(y>1) = 1;return